# docker

## linux 系统直接使用

```bash
yum install docker

# 配置镜像
vi /etc/docker/daemon.json

{
"registry-mirrors": [
        "https://docker.m.daocloud.io",
        "https://dockerproxy.com",
        "https://docker.mirrors.ustc.edu.cn",
        "https://docker.nju.edu.cn"
    ]
}

# 拉取jenkins镜像
docker pull jenkins/jenkins

# 启动jenkins
docker run -d -u root -p 8080:8080 -p 50000:50000 --name jenkins --restart=always -v /var/jenkins_home:/var/jenkins_home -v /etc/localtime:/etc/localtime jenkins/jenkins

# 启动失败，查看日志
docker logs jenkins

# 权限问题，修改 jenkins_home权限
sudo chown -R 1000:1000 /var/jenkins_home

# 进入容器
docker exec -it jenkins bash

# 修改密码
vi /var/jenkins_home/secrets/initialAdminPassword

# 修改权限
chmod 777 /var/jenkins_home/secrets/initialAdminPassword
```

## 使用包含 Node.js 的 Jenkins 镜像

在工作目录下创建 Dockerfile 文件：

```bash
# 使用官方 Jenkins 镜像作为基础镜像
FROM jenkins/jenkins:lts

# 切换到 root 用户以安装软件包
USER root

# 更新包索引并安装必要的软件包
RUN apt-get update && \
    apt-get install -y curl software-properties-common && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm@latest

# 清理缓存以减小镜像体积
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# 切换回 Jenkins 用户
USER jenkins

# 可选：验证 Node.js 和 npm 安装
# RUN node -v && npm -v
```

在包含 Dockerfile 的目录中运行以下命令来构建镜像

```bash
docker build -t jenkins-nodejs:latest .
```

使用构建的镜像启动 Jenkins 容器：

```bash
docker run -d \
  -u root \
  --name jenkins \
  -p 8080:8080 \
  -p 50000:50000 \
  -v jenkins_home:/var/jenkins_home \
  jenkins-nodejs:latest

# -d: 后台运行容器。
# -u root: 使用 root 用户运行容器，以便安装软件包。
# --name jenkins: 指定容器名称为 jenkins。
# -p 8080:8080: 映射 Jenkins 的 Web 界面端口。
# -p 50000:50000: 映射 Jenkins 的 JNLP 端口（通常用于代理）。
# -v jenkins_home:/var/jenkins_home: 持久化 Jenkins 数据。jenkins_home 是一个命名卷，你可以根据需要更改。
```
